# Node.js WebSocket Chat Application with MySQL

·ª®ng d·ª•ng chat real-time full-stack s·ª≠ d·ª•ng Node.js, Socket.IO, MySQL v√† Sequelize ORM. H·ªó tr·ª£ authentication, qu·∫£n l√Ω ph√≤ng chat, v√† nhi·ªÅu t√≠nh nƒÉng n√¢ng cao.

## üìã M·ª•c l·ª•c
- [T·ªïng quan](#t·ªïng-quan)
- [C·∫•u tr√∫c d·ª± √°n](#c·∫•u-tr√∫c-d·ª±-√°n)
- [Ki·∫øn tr√∫c h·ªá th·ªëng](#ki·∫øn-tr√∫c-h·ªá-th·ªëng)
- [C√†i ƒë·∫∑t v√† ch·∫°y](#c√†i-ƒë·∫∑t-v√†-ch·∫°y)
- [API Documentation](#api-documentation)
- [WebSocket Events](#websocket-events)
- [Database Schema](#database-schema)
- [T√≠nh nƒÉng](#t√≠nh-nƒÉng)
- [C·∫•u h√¨nh](#c·∫•u-h√¨nh)

## üéØ T·ªïng quan

·ª®ng d·ª•ng chat real-time enterprise-grade v·ªõi c√°c t√≠nh nƒÉng:
- Authentication v√† authorization
- Qu·∫£n l√Ω ph√≤ng chat (public/private)
- Message persistence v·ªõi MySQL
- Real-time messaging v·ªõi Socket.IO
- File upload v√† sharing
- Message reactions v√† read receipts
- Typing indicators
- Redis adapter cho scaling

## üìÅ C·∫•u tr√∫c d·ª± √°n

```
nodejs-websocket-chat/
‚îú‚îÄ‚îÄ server.js                    # Entry point
‚îú‚îÄ‚îÄ package.json                 # Dependencies v√† scripts
‚îú‚îÄ‚îÄ .env                         # Environment variables
‚îú‚îÄ‚îÄ .gitignore                   # Git ignore rules
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.js          # MySQL/Sequelize config
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redis.js             # Redis connection
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ socket.js            # Socket.IO initialization
‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authController.js    # Authentication logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chatController.js    # Chat operations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ roomController.js    # Room management
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ userController.js    # User management
‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.js              # JWT authentication
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validation.js        # Input validation
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ socketAuth.js        # Socket authentication
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ User.js              # User model (Sequelize)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Room.js              # Room model
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Message.js           # Message model
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RoomMember.js        # Room membership
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MessageReaction.js   # Message reactions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MessageRead.js       # Read receipts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.js             # Model associations
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.js              # Authentication routes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat.js              # Chat API routes
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ room.js              # Room management routes
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ socketService.js     # WebSocket business logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chatService.js       # Chat operations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authService.js       # Auth operations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ userService.js       # User operations
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jwt.js               # JWT utilities
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.js            # Winston logging
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validation.js        # Validation helpers
‚îÇ   ‚îî‚îÄ‚îÄ database/
‚îÇ       ‚îú‚îÄ‚îÄ migrate.js           # Database migration
‚îÇ       ‚îî‚îÄ‚îÄ seed.js              # Sample data seeding
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îú‚îÄ‚îÄ index.html               # Chat interface
‚îÇ   ‚îú‚îÄ‚îÄ login.html               # Login page
‚îÇ   ‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ styles.css           # Styling
‚îÇ   ‚îî‚îÄ‚îÄ js/
‚îÇ       ‚îú‚îÄ‚îÄ chat.js              # Client WebSocket logic
‚îÇ       ‚îú‚îÄ‚îÄ auth.js              # Client authentication
‚îÇ       ‚îî‚îÄ‚îÄ utils.js             # Utility functions
‚îú‚îÄ‚îÄ uploads/                     # File upload directory
‚îî‚îÄ‚îÄ logs/                        # Application logs
```

## üèóÔ∏è Ki·∫øn tr√∫c h·ªá th·ªëng

### **Lu·ªìng ho·∫°t ƒë·ªông t·ªïng quan:**

```mermaid
graph TB
    A[Client Browser] --> B[Express Server]
    B --> C[Socket.IO Server]
    B --> D[MySQL Database]
    B --> E[Redis Cache]
    C --> F[SocketService]
    F --> G[ChatService]
    G --> D
    
    subgraph "Authentication Flow"
    H[JWT Token] --> I[Auth Middleware]
    I --> J[Socket Auth]
    end
    
    subgraph "Real-time Features"
    K[Typing Indicators]
    L[Message Broadcasting]
    M[User Status]
    N[Read Receipts]
    end
```

### **1. Server Initialization** ([server.js](server.js))

```javascript
Express Server + HTTP Server + Socket.IO
‚Üì
Database Connection (MySQL + Redis)
‚Üì
Middleware Setup (Auth, CORS, Security)
‚Üì
Routes Registration
‚Üì
Socket.IO Initialization
```

### **2. Authentication Flow**

```javascript
User Login ‚Üí JWT Token Generated
‚Üì
Token sent in Authorization header
‚Üì
JWT Middleware validates token
‚Üì
User object attached to req/socket
‚Üì
Access granted to protected resources
```

### **3. WebSocket Connection Flow**

```javascript
Client connects with JWT token
‚Üì
socketAuth middleware validates
‚Üì
User joins their rooms automatically
‚Üì
Connection stored in memory + Redis
‚Üì
Real-time events handling begins
```

### **4. Message Flow**

```javascript
User types message ‚Üí Typing indicator sent
‚Üì
Message sent via socket.emit('send_message')
‚Üì
Server validates + saves to MySQL
‚Üì
Message broadcasted to room members
‚Üì
Read receipts tracking
‚Üì
Message reactions support
```

## üöÄ C√†i ƒë·∫∑t v√† ch·∫°y

### **Prerequisites:**
- Node.js (v16+)
- MySQL (v8.0+)
- Redis (v6.0+) - Optional cho scaling
- npm ho·∫∑c yarn

### **1. C√†i ƒë·∫∑t MySQL:**

```bash
# macOS (Homebrew)
brew install mysql
brew services start mysql

# Ubuntu/Debian
sudo apt update
sudo apt install mysql-server
sudo systemctl start mysql

# Windows - Download MySQL Installer
```

### **2. T·∫°o Database:**

```sql
-- ƒêƒÉng nh·∫≠p MySQL
mysql -u root -p

-- T·∫°o database v√† user
CREATE DATABASE websocket_chat;
CREATE USER 'chatuser'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON websocket_chat.* TO 'chatuser'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### **3. C√†i ƒë·∫∑t Redis (Optional):**

```bash
# macOS
brew install redis
brew services start redis

# Ubuntu
sudo apt install redis-server
sudo systemctl start redis
```

### **4. Setup Project:**

```bash
# Clone repository
git clone <your-repo>
cd nodejs-websocket-chat

# Install dependencies
npm install

# Copy v√† configure environment
cp .env.example .env
# Ch·ªânh s·ª≠a .env v·ªõi th√¥ng tin database c·ªßa b·∫°n

# Run migrations (t·∫°o tables)
npm run migrate

# Seed sample data
npm run seed
```

### **5. Environment Configuration (.env):**

```bash
# Server
PORT=3000
NODE_ENV=development

# MySQL Database
DB_HOST=localhost
DB_PORT=3306
DB_NAME=websocket_chat
DB_USER=chatuser
DB_PASS=your_password

# Redis (Optional)
REDIS_URL=redis://localhost:6379

# JWT Secret
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production

# CORS
FRONTEND_URL=http://localhost:3000

# File Upload
MAX_FILE_SIZE=10485760
UPLOAD_DIR=uploads
```

### **6. Ch·∫°y Application:**

```bash
# Development mode
npm run dev

# Production mode
npm start

# Run tests
npm test
```

### **7. Truy c·∫≠p Application:**

- **Chat App:** `http://localhost:3000`
- **Login Page:** `http://localhost:3000/login`

**Demo Accounts:**
- Username: `admin` | Password: `password`
- Username: `user1` | Password: `password`
- Username: `user2` | Password: `password`

## üì° API Documentation

### **Authentication Endpoints:**

| Method | Endpoint | Body | Response | Description |
|--------|----------|------|----------|-------------|
| POST | `/api/auth/register` | `{username, email, password}` | `{token, user}` | ƒêƒÉng k√Ω user m·ªõi |
| POST | `/api/auth/login` | `{username, password}` | `{token, user}` | ƒêƒÉng nh·∫≠p |
| POST | `/api/auth/logout` | - | `{message}` | ƒêƒÉng xu·∫•t |
| GET | `/api/auth/profile` | - | `{user}` | L·∫•y th√¥ng tin user |

### **Chat Endpoints:**

| Method | Endpoint | Body/Params | Response | Description |
|--------|----------|-------------|----------|-------------|
| GET | `/api/chat/rooms/:roomId/messages` | `page, limit` | `{messages, pagination}` | L·∫•y tin nh·∫Øn ph√≤ng |
| PUT | `/api/chat/messages/:messageId` | `{content}` | `{message}` | S·ª≠a tin nh·∫Øn |
| DELETE | `/api/chat/messages/:messageId` | - | `{message}` | X√≥a tin nh·∫Øn |
| POST | `/api/chat/message` | `{msg, roomId}` | `{message}` | G·ª≠i tin nh·∫Øn (HTTP) |

### **Room Endpoints:**

| Method | Endpoint | Body | Response | Description |
|--------|----------|------|----------|-------------|
| GET | `/api/rooms` | - | `{rooms}` | L·∫•y danh s√°ch ph√≤ng |
| POST | `/api/rooms` | `{name, description, type}` | `{room}` | T·∫°o ph√≤ng m·ªõi |
| PUT | `/api/rooms/:roomId` | `{name, description}` | `{room}` | C·∫≠p nh·∫≠t ph√≤ng |
| DELETE | `/api/rooms/:roomId` | - | `{message}` | X√≥a ph√≤ng |
| POST | `/api/rooms/:roomId/join` | - | `{message}` | Tham gia ph√≤ng |
| POST | `/api/rooms/:roomId/leave` | - | `{message}` | R·ªùi ph√≤ng |

### **Authentication Required:**
T·∫•t c·∫£ API endpoints (tr·ª´ register/login) c·∫ßn header:
```
Authorization: Bearer <JWT_TOKEN>
```

## ‚ö° WebSocket Events

### **Connection Events:**

| Event | Direction | Data | Description |
|-------|-----------|------|-------------|
| `connect` | Server ‚Üí Client | - | K·∫øt n·ªëi th√†nh c√¥ng |
| `disconnect` | Server ‚Üí Client | `{reason}` | Ng·∫Øt k·∫øt n·ªëi |
| `error` | Server ‚Üí Client | `{message}` | L·ªói x·∫£y ra |

### **Message Events:**

| Event | Direction | Data Type | Description |
|-------|-----------|-----------|-------------|
| `send_message` | Client ‚Üí Server | `{roomId, content, type, replyTo}` | G·ª≠i tin nh·∫Øn |
| `new_message` | Server ‚Üí Client | `{id, senderId, senderName, content, timestamp, roomId}` | Tin nh·∫Øn m·ªõi |
| `message_edited` | Server ‚Üí Client | `{messageId, content, editedAt}` | Tin nh·∫Øn ƒë√£ s·ª≠a |
| `message_deleted` | Server ‚Üí Client | `{messageId, content}` | Tin nh·∫Øn ƒë√£ x√≥a |

### **Room Events:**

| Event | Direction | Data | Description |
|-------|-----------|------|-------------|
| `join_room` | Client ‚Üí Server | `{roomId}` | Tham gia ph√≤ng |
| `leave_room` | Client ‚Üí Server | `{roomId}` | R·ªùi ph√≤ng |
| `room_messages` | Server ‚Üí Client | `{roomId, messages}` | Tin nh·∫Øn ph√≤ng |
| `user_joined_room` | Server ‚Üí Client | `{userId, username, roomId}` | User tham gia |
| `user_left_room` | Server ‚Üí Client | `{userId, username, roomId}` | User r·ªùi ƒëi |

### **Typing Events:**

| Event | Direction | Data | Description |
|-------|-----------|------|-------------|
| `typing_start` | Client ‚Üí Server | `{roomId}` | B·∫Øt ƒë·∫ßu g√µ |
| `typing_stop` | Client ‚Üí Server | `{roomId}` | Ng·ª´ng g√µ |
| `user_typing` | Server ‚Üí Client | `{userId, username, isTyping}` | User ƒëang g√µ |

### **User Status Events:**

| Event | Direction | Data | Description |
|-------|-----------|------|-------------|
| `users_online` | Server ‚Üí Client | `[{userId, username, status}]` | Danh s√°ch user online |
| `user_status_changed` | Server ‚Üí Client | `{userId, status, timestamp}` | Thay ƒë·ªïi tr·∫°ng th√°i |

### **Example Usage:**

```javascript
// Client-side
const socket = io({
  auth: {
    token: localStorage.getItem('authToken')
  }
});

// G·ª≠i tin nh·∫Øn
socket.emit('send_message', {
  roomId: 'room-uuid',
  content: 'Hello world!',
  type: 'text'
});

// Nh·∫≠n tin nh·∫Øn
socket.on('new_message', (message) => {
  console.log('New message:', message);
  displayMessage(message);
});

// Typing indicators
socket.emit('typing_start', { roomId: 'room-uuid' });
socket.on('user_typing', (data) => {
  showTypingIndicator(data.username);
});
```

## üóÑÔ∏è Database Schema

### **Users Table:**
```sql
CREATE TABLE users (
  id VARCHAR(36) PRIMARY KEY,
  username VARCHAR(30) UNIQUE NOT NULL,
  email VARCHAR(100) UNIQUE NOT NULL,
  password VARCHAR(255) NOT NULL,
  avatar VARCHAR(255),
  status ENUM('online', 'offline', 'away', 'busy') DEFAULT 'offline',
  lastSeen DATETIME,
  isActive BOOLEAN DEFAULT true,
  createdAt DATETIME,
  updatedAt DATETIME
);
```

### **Rooms Table:**
```sql
CREATE TABLE rooms (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  type ENUM('public', 'private', 'direct') DEFAULT 'public',
  ownerId VARCHAR(36) NOT NULL,
  settings JSON,
  lastActivity DATETIME,
  isActive BOOLEAN DEFAULT true,
  createdAt DATETIME,
  updatedAt DATETIME,
  FOREIGN KEY (ownerId) REFERENCES users(id)
);
```

### **Messages Table:**
```sql
CREATE TABLE messages (
  id VARCHAR(36) PRIMARY KEY,
  senderId VARCHAR(36) NOT NULL,
  roomId VARCHAR(36) NOT NULL,
  content TEXT NOT NULL,
  type ENUM('text', 'image', 'file', 'system') DEFAULT 'text',
  fileUrl VARCHAR(255),
  fileName VARCHAR(255),
  fileSize INT,
  replyToId VARCHAR(36),
  edited BOOLEAN DEFAULT false,
  editedAt DATETIME,
  isDeleted BOOLEAN DEFAULT false,
  createdAt DATETIME,
  updatedAt DATETIME,
  FOREIGN KEY (senderId) REFERENCES users(id),
  FOREIGN KEY (roomId) REFERENCES rooms(id),
  FOREIGN KEY (replyToId) REFERENCES messages(id)
);
```

### **Room Members (Junction Table):**
```sql
CREATE TABLE room_members (
  id VARCHAR(36) PRIMARY KEY,
  userId VARCHAR(36) NOT NULL,
  roomId VARCHAR(36) NOT NULL,
  role ENUM('admin', 'moderator', 'member') DEFAULT 'member',
  joinedAt DATETIME,
  createdAt DATETIME,
  updatedAt DATETIME,
  UNIQUE KEY unique_user_room (userId, roomId),
  FOREIGN KEY (userId) REFERENCES users(id),
  FOREIGN KEY (roomId) REFERENCES rooms(id)
);
```

## ‚ú® T√≠nh nƒÉng

### **Core Features:**
- ‚úÖ **Real-time Messaging** - Socket.IO bidirectional communication
- ‚úÖ **User Authentication** - JWT-based v·ªõi bcrypt password hashing
- ‚úÖ **Room Management** - Public/Private rooms v·ªõi role-based permissions
- ‚úÖ **Message Persistence** - MySQL database v·ªõi Sequelize ORM
- ‚úÖ **File Upload** - Multer middleware cho file sharing
- ‚úÖ **Message History** - Pagination v√† search functionality

### **Advanced Features:**
- ‚úÖ **Typing Indicators** - Real-time typing status
- ‚úÖ **Online Status** - User presence tracking
- ‚úÖ **Message Reactions** - Emoji reactions h·ªá th·ªëng
- ‚úÖ **Read Receipts** - Message ƒë·ªçc tracking
- ‚úÖ **Message Threading** - Reply to messages
- ‚úÖ **Message Editing/Deletion** - v·ªõi time constraints

### **Technical Features:**
- ‚úÖ **Auto-reconnection** - Socket.IO t·ª± ƒë·ªông reconnect
- ‚úÖ **Error Handling** - Comprehensive error management
- ‚úÖ **Input Validation** - Joi validation middleware
- ‚úÖ **Security** - Helmet, CORS, Rate limiting
- ‚úÖ **Logging** - Winston logger v·ªõi file rotation
- ‚úÖ **Database Migration** - Sequelize migration system

### **Scalability Features:**
- ‚úÖ **Redis Adapter** - Multiple server instances support
- ‚úÖ **Connection Pooling** - Database connection optimization
- ‚úÖ **Caching** - Redis caching layer
- ‚úÖ **Load Balancing Ready** - Stateless design

## üîß C·∫•u h√¨nh

### **Production Deployment:**

```bash
# Install PM2 for process management
npm install -g pm2

# Start application with PM2
pm2 start ecosystem.config.js

# Configure nginx reverse proxy
# /etc/nginx/sites-available/chat-app
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### **Docker Deployment:**

```dockerfile
FROM node:16-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

CMD ["npm", "start"]
```

### **Environment Variables:**

| Variable | Default | Description |
|----------|---------|-------------|
| `PORT` | 3000 | Server port |
| `NODE_ENV` | development | Environment |
| `DB_HOST` | localhost | MySQL host |
| `DB_PORT` | 3306 | MySQL port |
| `DB_NAME` | websocket_chat | Database name |
| `DB_USER` | root | Database user |
| `DB_PASS` | - | Database password |
| `REDIS_URL` | redis://localhost:6379 | Redis connection |
| `JWT_SECRET` | - | JWT signing secret |
| `MAX_FILE_SIZE` | 10MB | Max upload size |

### **Performance Tuning:**

```javascript
// Socket.IO configuration
const io = new Server(server, {
  pingTimeout: 60000,
  pingInterval: 25000,
  transports: ['websocket', 'polling'],
  upgradeTimeout: 30000,
  maxHttpBufferSize: 1e6
});

// MySQL connection pool
const sequelize = new Sequelize({
  pool: {
    max: 10,
    min: 0,
    acquire: 30000,
    idle: 10000
  }
});
```

## üß™ Testing

```bash
# Run tests
npm test

# Run with coverage
npm run test:coverage

# Run integration tests
npm run test:integration
```

## üìù Contributing

1. Fork the repository
2. Create feature branch (`git checkout -b feature/amazing-feature`)
3. Commit changes (`git commit -m 'Add amazing feature'`)
4. Push to branch (`git push origin feature/amazing-feature`)
5. Open Pull Request

## üìÑ License

This project is licensed under the MIT License - see the LICENSE file for details.

## üìû Support

N·∫øu g·∫∑p v·∫•n ƒë·ªÅ ho·∫∑c c√≥ c√¢u h·ªèi:
- T·∫°o issue tr√™n GitHub
- Email: your-email@example.com
- Documentation: [Wiki](link-to-wiki)

---

**Made with ‚ù§Ô∏è using Node.js, Socket.IO v√† MySQL**